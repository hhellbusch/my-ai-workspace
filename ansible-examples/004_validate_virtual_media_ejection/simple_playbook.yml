---
# Simplified version of the virtual media ejection with validation
# This is a minimal example for quick reference

- name: Simple virtual media eject with validation
  hosts: localhost
  gather_facts: false
  
  vars:
    idrac_ip: "192.168.1.100"
    idrac_user: "root"
    idrac_password: "calvin"
    
  tasks:
    - name: Eject virtual media
      dellemc.openmanage.idrac_virtual_media:
        idrac_ip: "{{ idrac_ip }}"
        idrac_user: "{{ idrac_user }}"
        idrac_password: "{{ idrac_password }}"
        validate_certs: false
        virtual_media:
          - index: 1
            state: "absent"
      register: eject_result

    - name: Check ejection result
      assert:
        that:
          - not eject_result.failed
        fail_msg: "Ejection failed"

    - name: Wait for operation to complete
      pause:
        seconds: 5

    - name: Query virtual media status
      dellemc.openmanage.idrac_system_info:
        idrac_ip: "{{ idrac_ip }}"
        idrac_user: "{{ idrac_user }}"
        idrac_password: "{{ idrac_password }}"
        validate_certs: false
      register: status
      until: >
        status.system_info is defined and
        status.system_info.VirtualMedia is defined and
        (status.system_info.VirtualMedia | 
         selectattr('Index', 'equalto', 1) | 
         map(attribute='Inserted') | first | default(true) == false)
      retries: 5
      delay: 5

    - name: Confirm ejection
      debug:
        msg: "Virtual media successfully ejected and validated"

