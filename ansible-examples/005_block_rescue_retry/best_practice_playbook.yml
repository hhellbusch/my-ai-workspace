---
- name: Block/Rescue with Recovery - Best Practice Pattern
  hosts: localhost
  gather_facts: false

  tasks:
    # ====================================================================
    # Setup: Create flaky environment for demo
    # ====================================================================
    - name: Setup - Initialize service health counter
      ansible.builtin.copy:
        content: "0"
        dest: /tmp/service_health
        mode: '0644'

    - name: Initialize status tracking
      ansible.builtin.set_fact:
        operation_succeeded: false
        max_attempts: 3

    # ====================================================================
    # Pattern: Block/Rescue - Attempt 1
    # ====================================================================
    - name: Attempt 1 - Try the flaky operation
      block:
        - name: Show attempt number
          ansible.builtin.debug:
            msg: "üîÑ Attempt 1/3"

        - name: Check service health
          ansible.builtin.shell: cat /tmp/service_health
          register: health
          changed_when: false

        - name: Execute flaky operation
          ansible.builtin.shell: |
            if [ "{{ health.stdout }}" -lt "2" ]; then
              echo "Service not ready (health: {{ health.stdout }})"
              exit 1
            fi
            echo "Success!"
          register: result

        - name: Mark as succeeded
          ansible.builtin.set_fact:
            operation_succeeded: true

      rescue:
        - name: Log failure
          ansible.builtin.debug:
            msg: "‚ö†Ô∏è  Attempt 1 failed. Starting recovery..."

        - name: Recovery - Clear cache
          ansible.builtin.debug:
            msg: "üîß Clearing cache..."

        - name: Recovery - Restart service
          ansible.builtin.debug:
            msg: "üîÑ Restarting service..."

        - name: Recovery - Improve health
          ansible.builtin.shell: |
            current=$(cat /tmp/service_health)
            echo $((current + 1)) > /tmp/service_health
          changed_when: true

        - name: Wait for stabilization
          ansible.builtin.pause:
            seconds: 1

      when: not operation_succeeded

    # ====================================================================
    # Pattern: Block/Rescue - Attempt 2
    # ====================================================================
    - name: Attempt 2 - Try the flaky operation
      block:
        - name: Show attempt number
          ansible.builtin.debug:
            msg: "üîÑ Attempt 2/3"

        - name: Check service health
          ansible.builtin.shell: cat /tmp/service_health
          register: health
          changed_when: false

        - name: Execute flaky operation
          ansible.builtin.shell: |
            if [ "{{ health.stdout }}" -lt "2" ]; then
              echo "Service not ready (health: {{ health.stdout }})"
              exit 1
            fi
            echo "Success!"
          register: result

        - name: Mark as succeeded
          ansible.builtin.set_fact:
            operation_succeeded: true

      rescue:
        - name: Log failure
          ansible.builtin.debug:
            msg: "‚ö†Ô∏è  Attempt 2 failed. Starting recovery..."

        - name: Recovery - Clear cache
          ansible.builtin.debug:
            msg: "üîß Clearing cache..."

        - name: Recovery - Restart service
          ansible.builtin.debug:
            msg: "üîÑ Restarting service..."

        - name: Recovery - Improve health
          ansible.builtin.shell: |
            current=$(cat /tmp/service_health)
            echo $((current + 1)) > /tmp/service_health
          changed_when: true

        - name: Wait for stabilization
          ansible.builtin.pause:
            seconds: 1

      when: not operation_succeeded

    # ====================================================================
    # Pattern: Block/Rescue - Attempt 3 (Final)
    # ====================================================================
    - name: Attempt 3 - Try the flaky operation (final attempt)
      block:
        - name: Show attempt number
          ansible.builtin.debug:
            msg: "üîÑ Attempt 3/3 (final attempt)"

        - name: Check service health
          ansible.builtin.shell: cat /tmp/service_health
          register: health
          changed_when: false

        - name: Execute flaky operation
          ansible.builtin.shell: |
            if [ "{{ health.stdout }}" -lt "2" ]; then
              echo "Service not ready (health: {{ health.stdout }})"
              exit 1
            fi
            echo "Success!"
          register: result

        - name: Mark as succeeded
          ansible.builtin.set_fact:
            operation_succeeded: true

      rescue:
        - name: Final attempt failed
          ansible.builtin.fail:
            msg: "‚ùå All 3 attempts failed. Operation could not be completed."

      when: not operation_succeeded

    # ====================================================================
    # Success and cleanup
    # ====================================================================
    - name: Operation completed successfully
      ansible.builtin.debug:
        msg: "‚úÖ Operation succeeded!"
      when: operation_succeeded

    - name: Cleanup demo files
      ansible.builtin.file:
        path: /tmp/service_health
        state: absent
