---
# This playbook demonstrates ejecting virtual media from Dell iDRAC
# and validating that the ejection was successful
#
# Usage:
#   ansible-playbook playbook.yml -e "idrac_ip=192.168.1.100" \
#                                  -e "idrac_user=root" \
#                                  -e "idrac_password=calvin"

- name: Eject and validate iDRAC virtual media
  hosts: localhost
  gather_facts: false
  
  vars:
    # Override these via command line or inventory
    idrac_ip: "{{ idrac_ip | default('192.168.1.100') }}"
    idrac_user: "{{ idrac_user | default('root') }}"
    idrac_password: "{{ idrac_password | default('calvin') }}"
    validate_certs: false
    
    # Virtual media settings
    media_index: 1  # CD/DVD is typically index 1
    max_validation_retries: 5
    validation_delay: 5
    
  tasks:
    - name: Display target iDRAC
      debug:
        msg: "Ejecting virtual media from iDRAC: {{ idrac_ip }}"

    # ========================================================================
    # METHOD 1: Simple ejection with return value check
    # ========================================================================
    - name: "METHOD 1: Eject virtual media and check return value"
      block:
        - name: Eject virtual media
          dellemc.openmanage.idrac_virtual_media:
            idrac_ip: "{{ idrac_ip }}"
            idrac_user: "{{ idrac_user }}"
            idrac_password: "{{ idrac_password }}"
            validate_certs: "{{ validate_certs }}"
            virtual_media:
              - index: "{{ media_index }}"
                state: "absent"
          register: eject_result

        - name: Display ejection result
          debug:
            var: eject_result
            verbosity: 1

        - name: Verify ejection command succeeded
          assert:
            that:
              - eject_result.failed == false
              - eject_result.changed == true or eject_result.msg is search("No changes found")
            fail_msg: "Virtual media ejection command failed"
            success_msg: "Virtual media ejection command completed successfully"

      rescue:
        - name: Handle ejection failure
          debug:
            msg: "WARNING: Failed to eject virtual media - {{ ansible_failed_result.msg | default('Unknown error') }}"
          
        - name: Continue to validation attempt
          meta: clear_host_errors

    # ========================================================================
    # METHOD 2: Query and validate actual status
    # ========================================================================
    - name: "METHOD 2: Validate ejection by querying virtual media status"
      block:
        - name: Wait for iDRAC to process ejection
          pause:
            seconds: 3
            prompt: "Waiting for iDRAC to process ejection request"

        - name: Query virtual media status
          dellemc.openmanage.idrac_system_info:
            idrac_ip: "{{ idrac_ip }}"
            idrac_user: "{{ idrac_user }}"
            idrac_password: "{{ idrac_password }}"
            validate_certs: "{{ validate_certs }}"
          register: idrac_status
          until: >
            idrac_status.system_info is defined and
            idrac_status.system_info.VirtualMedia is defined and
            (idrac_status.system_info.VirtualMedia | 
             selectattr('Index', 'equalto', media_index) | 
             map(attribute='Inserted') | first | default(true) == false)
          retries: "{{ max_validation_retries }}"
          delay: "{{ validation_delay }}"

        - name: Display virtual media status
          debug:
            msg: "Virtual Media Status: {{ idrac_status.system_info.VirtualMedia }}"
            verbosity: 1

        - name: Extract target media info
          set_fact:
            target_media: "{{ idrac_status.system_info.VirtualMedia | selectattr('Index', 'equalto', media_index) | first }}"

        - name: Display target media details
          debug:
            msg:
              - "Media Index: {{ target_media.Index }}"
              - "Media Type: {{ target_media.MediaTypes | default('Unknown') }}"
              - "Inserted: {{ target_media.Inserted }}"
              - "Image: {{ target_media.Image | default('None') }}"
              - "Connected Via: {{ target_media.ConnectedVia | default('Unknown') }}"

        - name: Assert media is ejected
          assert:
            that:
              - target_media.Inserted == false
              - target_media.Image == "" or target_media.Image == null or target_media.Image is not defined
            fail_msg: |
              VALIDATION FAILED: Virtual media is still attached!
              Inserted: {{ target_media.Inserted }}
              Image: {{ target_media.Image | default('None') }}
            success_msg: "VALIDATION PASSED: Virtual media successfully ejected and verified"

      rescue:
        - name: Log validation failure details
          debug:
            msg:
              - "VALIDATION FAILED after {{ max_validation_retries }} retries"
              - "iDRAC IP: {{ idrac_ip }}"
              - "Media Index: {{ media_index }}"
              - "Last status: {{ idrac_status | default('No status retrieved') }}"

        - name: Fail playbook on validation failure
          fail:
            msg: "Virtual media ejection could not be validated"

    # ========================================================================
    # Final confirmation
    # ========================================================================
    - name: Final success message
      debug:
        msg:
          - "=========================================="
          - "SUCCESS: Virtual media ejection validated"
          - "=========================================="
          - "iDRAC: {{ idrac_ip }}"
          - "Media Index: {{ media_index }}"
          - "Status: Ejected and confirmed"
          - "=========================================="

    # ========================================================================
    # Optional: Include separate validation tasks (with retry logic)
    # ========================================================================
    - name: "METHOD 3: Use separate validation task file with built-in retry logic"
      include_tasks: validate_ejection.yml
      vars:
        # These variables are passed to the reusable task
        media_index: "{{ media_index }}"
        max_validation_retries: "{{ max_validation_retries }}"
        validation_delay: "{{ validation_delay }}"
      when: false  # Set to true to enable this method (already validated above)

