---
# Reusable validation tasks for virtual media ejection
# This file can be included in any playbook that needs to validate
# virtual media status
#
# Required variables:
#   - idrac_ip
#   - idrac_user
#   - idrac_password
#   - media_index (optional, defaults to 1)
#   - max_validation_retries (optional, defaults to 5)
#   - validation_delay (optional, defaults to 5)

- name: Set validation variables
  set_fact:
    validation_media_index: "{{ media_index | default(1) }}"
    max_retries: "{{ max_validation_retries | default(5) }}"
    retry_delay: "{{ validation_delay | default(5) }}"

- name: Query virtual media status from iDRAC with retry logic
  dellemc.openmanage.idrac_system_info:
    idrac_ip: "{{ idrac_ip }}"
    idrac_user: "{{ idrac_user }}"
    idrac_password: "{{ idrac_password }}"
    validate_certs: "{{ validate_certs | default(false) }}"
  register: media_query_result
  until: >
    media_query_result.system_info is defined and
    media_query_result.system_info.VirtualMedia is defined and
    (media_query_result.system_info.VirtualMedia | 
     selectattr('Index', 'equalto', validation_media_index) | 
     map(attribute='Inserted') | first | default(true) == false)
  retries: "{{ max_retries }}"
  delay: "{{ retry_delay }}"

- name: Extract media info for validation
  set_fact:
    validated_media: "{{ media_query_result.system_info.VirtualMedia | selectattr('Index', 'equalto', validation_media_index) | first }}"
  when: media_query_result.system_info.VirtualMedia is defined

- name: Display validation results
  debug:
    msg:
      - "Validation Results for Media Index {{ validation_media_index }}:"
      - "  Inserted: {{ validated_media.Inserted | default('Unknown') }}"
      - "  Image: {{ validated_media.Image | default('None') }}"
      - "  Connected Via: {{ validated_media.ConnectedVia | default('Unknown') }}"
      - "  Media Types: {{ validated_media.MediaTypes | default('Unknown') }}"

- name: Validate media is ejected
  assert:
    that:
      - validated_media is defined
      - validated_media.Inserted == false
      - validated_media.Image == "" or validated_media.Image == null or validated_media.Image is not defined
    fail_msg: |
      Virtual media validation FAILED for index {{ validation_media_index }}
      The media appears to still be inserted or has an image attached.
    success_msg: "Virtual media validation PASSED for index {{ validation_media_index }}"
