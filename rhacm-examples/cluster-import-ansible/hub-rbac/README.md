# RHACM Hub Cluster RBAC Configuration

This directory contains RBAC resources for creating a service account with minimal permissions to automate RHACM cluster imports.

## Overview

Instead of using cluster-admin kubeconfig, create a dedicated service account with least-privilege permissions:

- ✅ Create namespaces for imported clusters
- ✅ Create ManagedCluster resources
- ✅ Create KlusterletAddonConfig resources
- ✅ Read import secrets (auto-generated by RHACM)
- ✅ Read ManagedCluster status for validation
- ❌ No permissions to modify unrelated resources
- ❌ No permissions to delete clusters (safety)

## Quick Start

### 1. Apply RBAC Resources to Hub Cluster

```bash
# Apply all RBAC configurations
oc apply -f serviceaccount.yaml
oc apply -f clusterrole.yaml
oc apply -f clusterrolebinding.yaml
oc apply -f namespace-role.yaml
```

Or apply all at once:

```bash
oc apply -f hub-rbac/
```

### 2. Extract Service Account Token

**For OpenShift 4.11+** (using TokenRequest API):

```bash
#!/bin/bash
# extract-token.sh

SA_NAME="cluster-importer"
NAMESPACE="open-cluster-management"

# Create a long-lived token (1 year)
TOKEN=$(oc create token ${SA_NAME} -n ${NAMESPACE} --duration=8760h)

echo "Service account token:"
echo "$TOKEN"

# Save to file for Ansible
echo "$TOKEN" > /tmp/cluster-importer-token.txt
chmod 600 /tmp/cluster-importer-token.txt

echo ""
echo "Token saved to: /tmp/cluster-importer-token.txt"
```

**For OpenShift 4.10 and earlier** (using Secret-based tokens):

```bash
#!/bin/bash
# extract-token-legacy.sh

SA_NAME="cluster-importer"
NAMESPACE="open-cluster-management"

# Get the secret name
SECRET_NAME=$(oc get sa ${SA_NAME} -n ${NAMESPACE} \
  -o jsonpath='{.secrets[0].name}')

# Extract token
TOKEN=$(oc get secret ${SECRET_NAME} -n ${NAMESPACE} \
  -o jsonpath='{.data.token}' | base64 -d)

echo "Service account token:"
echo "$TOKEN"

# Save to file for Ansible
echo "$TOKEN" > /tmp/cluster-importer-token.txt
chmod 600 /tmp/cluster-importer-token.txt

echo ""
echo "Token saved to: /tmp/cluster-importer-token.txt"
```

### 3. Create Kubeconfig for Service Account

```bash
#!/bin/bash
# create-kubeconfig.sh

SA_NAME="cluster-importer"
NAMESPACE="open-cluster-management"
CLUSTER_NAME="rhacm-hub"  # Change to your hub cluster name
SERVER_URL=$(oc whoami --show-server)

# Extract CA certificate
CA_CERT=$(oc config view --raw -o jsonpath='{.clusters[0].cluster.certificate-authority-data}')

# Get token (use one of the methods above)
TOKEN=$(cat /tmp/cluster-importer-token.txt)

# Create kubeconfig
cat > /tmp/cluster-importer-kubeconfig <<EOF
apiVersion: v1
kind: Config
clusters:
  - cluster:
      certificate-authority-data: ${CA_CERT}
      server: ${SERVER_URL}
    name: ${CLUSTER_NAME}
contexts:
  - context:
      cluster: ${CLUSTER_NAME}
      namespace: ${NAMESPACE}
      user: ${SA_NAME}
    name: ${SA_NAME}@${CLUSTER_NAME}
current-context: ${SA_NAME}@${CLUSTER_NAME}
users:
  - name: ${SA_NAME}
    user:
      token: ${TOKEN}
EOF

chmod 600 /tmp/cluster-importer-kubeconfig

echo "Kubeconfig created: /tmp/cluster-importer-kubeconfig"
echo ""
echo "Test with:"
echo "  export KUBECONFIG=/tmp/cluster-importer-kubeconfig"
echo "  oc whoami"
echo "  oc auth can-i create managedcluster"
```

### 4. Update Ansible Inventory

Update `inventory/hosts.ini` to use the service account kubeconfig:

```ini
[rhacm_hub]
hub-cluster kubeconfig_path=/tmp/cluster-importer-kubeconfig
```

### 5. Test Permissions

```bash
# Set kubeconfig
export KUBECONFIG=/tmp/cluster-importer-kubeconfig

# Test basic access
oc whoami
# Expected: system:serviceaccount:open-cluster-management:cluster-importer

# Test permissions
oc auth can-i create managedcluster
# Expected: yes

oc auth can-i create namespace
# Expected: yes

oc auth can-i get secret -n test-cluster
# Expected: yes

oc auth can-i delete managedcluster
# Expected: no (by design - safety)

oc auth can-i create deployment
# Expected: no (not needed for cluster import)
```

## Files in This Directory

```
hub-rbac/
├── README.md                    # This file
├── serviceaccount.yaml          # ServiceAccount definition
├── clusterrole.yaml             # ClusterRole with import permissions
├── clusterrolebinding.yaml      # Bind ClusterRole to ServiceAccount
└── namespace-role.yaml          # Role for cluster namespace access
```

## Permissions Breakdown

### ClusterRole: cluster-importer

**Namespaces:**
- `create`, `get`, `list`, `watch` - Create namespaces for imported clusters

**Secrets:**
- `get`, `list`, `watch` - Read import secrets generated by RHACM
- Note: No `create` or `delete` - secrets are auto-generated

**ManagedCluster (cluster.open-cluster-management.io):**
- `create`, `get`, `list`, `watch`, `update`, `patch` - Full lifecycle management
- Status: `get`, `list`, `watch` - Read cluster status for validation

**KlusterletAddonConfig (agent.open-cluster-management.io):**
- `create`, `get`, `list`, `watch`, `update`, `patch` - Configure cluster add-ons

### ClusterRole: cluster-importer-namespace

**Scoped to cluster namespaces:**
- Read secrets in cluster namespace
- Manage KlusterletAddonConfig in cluster namespace
- Read ConfigMaps if needed

## Security Best Practices

### Token Management

**OpenShift 4.11+ (Recommended):**
- Use short-lived tokens with TokenRequest API
- Rotate tokens regularly (weekly/monthly)
- Set appropriate duration based on usage:
  - CI/CD: 1-2 hours (`--duration=2h`)
  - Automation: 24 hours (`--duration=24h`)
  - Long-running: 1 week max (`--duration=168h`)

**Token Rotation Script:**
```bash
#!/bin/bash
# rotate-token.sh

SA_NAME="cluster-importer"
NAMESPACE="open-cluster-management"

# Generate new token
NEW_TOKEN=$(oc create token ${SA_NAME} -n ${NAMESPACE} --duration=24h)

# Update kubeconfig (assumes standard structure)
KUBECONFIG_FILE="/path/to/cluster-importer-kubeconfig"
kubectl config set-credentials ${SA_NAME} --token="${NEW_TOKEN}" \
  --kubeconfig="${KUBECONFIG_FILE}"

echo "Token rotated successfully"
```

### Audit and Monitoring

**Enable audit logging** for service account actions:

```yaml
# OpenShift audit policy (cluster-wide)
apiVersion: audit.k8s.io/v1
kind: Policy
rules:
  - level: RequestResponse
    users:
      - system:serviceaccount:open-cluster-management:cluster-importer
    verbs: ["create", "update", "patch", "delete"]
```

**Monitor service account usage:**

```bash
# View recent actions by service account
oc adm node-logs --role=master --path=kube-apiserver/audit.log | \
  grep "cluster-importer" | tail -20
```

### Least Privilege Principle

This configuration follows security best practices:

✅ **Minimal Permissions**: Only what's needed for cluster import  
✅ **No Delete**: Can't accidentally delete clusters  
✅ **No Secrets Write**: Can't create/modify secrets  
✅ **Scoped Access**: Limited to RHACM-related resources  
✅ **Auditable**: All actions logged with service account identity  

### Integration with Vault/External Secrets

For production, store service account tokens in a secret manager:

**HashiCorp Vault:**
```bash
# Store token in Vault
vault kv put secret/rhacm/cluster-importer \
  token="$(cat /tmp/cluster-importer-token.txt)" \
  server="https://api.hub.example.com:6443"

# Retrieve in Ansible
- name: Get hub token from Vault
  set_fact:
    hub_token: "{{ lookup('community.hashi_vault.hashi_vault_read', 
                          'secret/data/rhacm/cluster-importer').token }}"
```

**AWS Secrets Manager:**
```bash
# Store token
aws secretsmanager create-secret \
  --name rhacm/cluster-importer-token \
  --secret-string file:///tmp/cluster-importer-token.txt

# Retrieve in Ansible
- name: Get hub token from AWS
  set_fact:
    hub_token: "{{ lookup('amazon.aws.aws_secret', 
                          'rhacm/cluster-importer-token') }}"
```

## Troubleshooting

### Permission Denied Errors

**Symptom**: Playbook fails with "forbidden" errors

**Check permissions:**
```bash
export KUBECONFIG=/tmp/cluster-importer-kubeconfig

# Test specific resource
oc auth can-i create managedcluster
oc auth can-i get secret -n test-namespace

# View effective permissions
oc auth can-i --list
```

**Common causes:**
- ClusterRoleBinding not applied
- Wrong namespace for ServiceAccount
- Token expired (for short-lived tokens)

### Token Expired

**Symptom**: "Unauthorized" or "invalid authentication token"

**Fix:**
```bash
# Generate new token
oc create token cluster-importer -n open-cluster-management \
  --duration=24h > /tmp/cluster-importer-token.txt

# Update kubeconfig
./create-kubeconfig.sh
```

### ServiceAccount Not Found

**Symptom**: "serviceaccounts 'cluster-importer' not found"

**Fix:**
```bash
# Verify ServiceAccount exists
oc get sa cluster-importer -n open-cluster-management

# If not, create it
oc apply -f serviceaccount.yaml
```

### Missing Namespace Permissions

**Symptom**: Can't read secrets in cluster namespace

**Fix:**
```bash
# Create RoleBinding for specific cluster namespace
cat <<EOF | oc apply -f -
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: cluster-importer
  namespace: prod-cluster-01
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-importer-namespace
subjects:
  - kind: ServiceAccount
    name: cluster-importer
    namespace: open-cluster-management
EOF
```

## Advanced Configuration

### Restrict to Specific Namespaces

If you want to limit which cluster namespaces the service account can access:

```yaml
# Replace ClusterRole with multiple Roles
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: cluster-importer
  namespace: prod-cluster-01  # Specific cluster namespace
rules:
  # Same rules as cluster-importer-namespace
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: cluster-importer
  namespace: prod-cluster-01
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: cluster-importer
subjects:
  - kind: ServiceAccount
    name: cluster-importer
    namespace: open-cluster-management
```

### Add ManagedClusterSet Management

To automatically assign clusters to sets, uncomment these lines in `clusterrole.yaml`:

```yaml
- apiGroups: ["cluster.open-cluster-management.io"]
  resources: ["managedclustersets"]
  verbs: ["get", "list", "watch"]

- apiGroups: ["cluster.open-cluster-management.io"]
  resources: ["managedclustersets/join"]
  verbs: ["create"]
```

Then add to your playbook:

```yaml
- name: Add cluster to ManagedClusterSet
  kubernetes.core.k8s:
    kubeconfig: "{{ hub_kubeconfig }}"
    state: present
    definition:
      apiVersion: cluster.open-cluster-management.io/v1beta2
      kind: ManagedClusterSetBinding
      metadata:
        name: production-clusters
        namespace: "{{ cluster_name }}"
      spec:
        clusterSet: production-clusters
```

## Related Documentation

- [Main Ansible Import README](../README.md)
- [RHACM Cluster Import Strategies](../../CLUSTER-IMPORT-AUTOMATION-STRATEGIES.md)
- [OpenShift Service Accounts](https://docs.openshift.com/container-platform/latest/authentication/using-service-accounts-in-applications.html)
- [Kubernetes RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)

---

**Version**: 1.0  
**Last Updated**: February 18, 2026  
**Tested With**: OpenShift 4.14+, RHACM 2.5+

**AI Disclosure**: This example was created with AI assistance as part of DevOps automation research and documentation efforts.
